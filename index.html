<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>학생 일정 관리 - 애플 스타일</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=SF+Pro+Text:wght@400;600&display=swap');

    /* 기본 스타일 */
    body {
      font-family: 'SF Pro Text', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen,
        Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0; padding: 20px;
      background: #f5f5f7;
      color: #1c1c1e;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      min-height: 100vh;
    }

    .student-section {
      max-width: 480px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      padding: 30px 25px 40px;
    }

    h2 {
      font-weight: 700;
      font-size: 2em;
      margin-bottom: 25px;
      color: #007aff;
      user-select: none;
    }

    .category {
      margin-bottom: 30px;
    }

    .category h3 {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-weight: 600;
      font-size: 1.2em;
      color: #1c1c1e;
      margin-bottom: 16px;
      user-select: none;
    }

    .add-btn {
      background: #007aff;
      border: none;
      color: white;
      font-weight: 600;
      font-size: 1em;
      padding: 6px 16px;
      border-radius: 15px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0,122,255,0.4);
      transition: background-color 0.25s ease;
    }

    .add-btn:hover {
      background: #005ecb;
    }

    .task-list {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .task {
      background: #f2f2f7;
      border-radius: 15px;
      padding: 14px 18px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      user-select: none;
    }

    .task span {
      font-weight: 500;
      font-size: 0.95em;
      color: #1c1c1e;
      flex-grow: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-right: 12px;
    }

    .date-label {
      background-color: #d0eaff;
      border-radius: 12px;
      color: #007aff;
      font-weight: 600;
      font-size: 0.85em;
      padding: 5px 12px;
      min-width: 80px;
      text-align: center;
      flex-shrink: 0;
      user-select: none;
      box-shadow: 0 0 6px rgba(0,122,255,0.3);
    }

    .btn-area {
      display: flex;
      gap: 10px;
      flex-shrink: 0;
    }

    .btn-area button {
      border: none;
      background: #007aff;
      color: white;
      font-weight: 600;
      padding: 6px 14px;
      border-radius: 14px;
      font-size: 0.9em;
      cursor: pointer;
      transition: background-color 0.25s ease;
      user-select: none;
      box-shadow: 0 2px 8px rgba(0,122,255,0.4);
    }

    .btn-area button:hover {
      background: #005ecb;
    }

    /* 입력폼 스타일 */
    .task input, .task select {
      border: 1.5px solid #ccc;
      border-radius: 12px;
      padding: 7px 12px;
      font-size: 0.95em;
      outline-offset: 2px;
      outline-color: #007aff;
      width: 100%;
      box-sizing: border-box;
      font-weight: 400;
      color: #1c1c1e;
      transition: border-color 0.3s ease;
      background: white;
      user-select: text;
    }

    .task label {
      flex: 1 1 100%;
      margin-bottom: 10px;
      font-weight: 600;
      color: #333;
      display: flex;
      flex-direction: column;
      gap: 4px;
      user-select: none;
    }

    .task select {
      cursor: pointer;
    }

    .task button {
      flex-shrink: 0;
      min-width: 72px;
      box-shadow: none;
      margin-left: 10px;
      background: #007aff;
      user-select: none;
    }

    .task button:hover {
      background: #005ecb;
    }

    /* 모바일 반응형 */
    @media (max-width: 520px) {
      body {
        padding: 15px 12px;
      }
      .student-section {
        padding: 25px 18px 30px;
      }
      .task {
        flex-direction: column;
        align-items: stretch;
      }
      .task span {
        margin-bottom: 8px;
        white-space: normal;
      }
      .btn-area {
        justify-content: flex-end;
      }
      .btn-area button {
        margin-left: 0;
      }
      .task label {
        font-size: 0.9em;
      }
    }
  </style>
</head>
<body>

<div class="student-section" id="student-JH">
  <h2>JH</h2>

  <div class="category" id="숙제-JH">
    <h3>숙제 <button class="add-btn" data-student="JH" data-category="숙제">+ 추가</button></h3>
    <div class="task-list"></div>
  </div>

  <div class="category" id="공부-JH">
    <h3>공부 <button class="add-btn" data-student="JH" data-category="공부">+ 추가</button></h3>
    <div class="task-list"></div>
  </div>

  <div class="category" id="시험-JH">
    <h3>시험 <button class="add-btn" data-student="JH" data-category="시험">+ 추가</button></h3>
    <div class="task-list"></div>
  </div>

  <div class="category" id="수행평가-JH">
    <h3>수행평가 <button class="add-btn" data-student="JH" data-category="수행평가">+ 추가</button></h3>
    <div class="task-list"></div>
  </div>

  <div class="category" id="completed-JH">
    <h3>완료된 항목</h3>
    <div class="task-list"></div>
  </div>

  <div class="category" id="deleted-JH">
    <h3>삭제된 항목
      <button class="clear-deleted-btn" style="background:#ff3b30; margin-left:10px;">비우기</button>
    </h3>
    <div class="task-list"></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref, set, remove, onValue } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBuhnhDDgnZkNMfFo3_0EsGrJzezKbTpZs",
    authDomain: "study-fbdae.firebaseapp.com",
    databaseURL: "https://study-fbdae-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "study-fbdae",
    storageBucket: "study-fbdae.appspot.com",
    messagingSenderId: "427130427133",
    appId: "1:427130427133:web:6e836cbbcd134fcde7d094"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const categoryFields = {
    '숙제': [
      { label: '과목', type: 'select', options: ['영어', '수학', '과학'] },
      { label: '범위', type: 'text' },
      { label: '마감일', type: 'date' }
    ],
    '공부': [
      { label: '과목', type: 'text' },
      { label: '범위', type: 'text' },
      { label: '마감일', type: 'date' }
    ],
    '시험': [
      { label: '과목', type: 'text' },
      { label: '범위', type: 'text' },
      { label: '마감일', type: 'date' }
    ],
    '수행평가': [
      { label: '내용', type: 'text' },
      { label: '마감일', type: 'date' }
    ]
  };

  // 날짜 'yy-mm-dd' 포맷 함수
  function formatDateShort(dateStr) {
    if (!dateStr) return '';
    const d = new Date(dateStr);
    if (isNaN(d)) return '';
    const yy = String(d.getFullYear()).slice(2);
    const mm = String(d.getMonth() + 1).padStart(2, '0');
    const dd = String(d.getDate()).padStart(2, '0');
    return `${yy}-${mm}-${dd}`;
  }

  // DB 저장 함수
  function saveTask(student, category, taskId, taskData) {
    return set(ref(db, `tasks/${student}/${category}/${taskId}`), taskData);
  }

  // DB 삭제 함수
  function deleteTask(student, category, taskId) {
    return remove(ref(db, `tasks/${student}/${category}/${taskId}`));
  }

  // DOM 생성 헬퍼
  function createElem(tag, attrs = {}, ...children) {
    const el = document.createElement(tag);
    for (const [key, val] of Object.entries(attrs)) {
      if (key === 'className') el.className = val;
      else if (key.startsWith('data-')) el.setAttribute(key, val);
      else if (key === 'htmlFor') el.htmlFor = val;
      else if (key === 'textContent') el.textContent = val;
      else el.setAttribute(key, val);
    }
    children.flat().forEach(c => {
      if (typeof c === 'string') el.appendChild(document.createTextNode(c));
      else if (c) el.appendChild(c);
    });
    return el;
  }

  // task item 생성 (입력폼 or display)
  function createTaskElement(student, category, taskId, data, isEditing = false) {
    const taskDiv = createElem('div', { className: 'task', 'data-task-id': taskId });

    if (isEditing) {
      // 입력폼
      const fields = categoryFields[category] || [];
      fields.forEach(({ label, type, options }) => {
        let inputElem;
        if (type === 'select' && options) {
          inputElem = createElem('select', {});
          options.forEach(opt => {
            const optionElem = createElem('option', { value: opt, textContent: opt });
            if (data[label] === opt) optionElem.selected = true;
            inputElem.appendChild(optionElem);
          });
        } else {
          inputElem = createElem('input', { type: type === 'date' ? 'date' : 'text', value: data[label] || '' });
        }
        const labelElem = createElem('label', {}, `${label}:`, inputElem);
        taskDiv.appendChild(labelElem);
      });

      const saveBtn = createElem('button', { textContent: '저장' });
      const cancelBtn = createElem('button', { textContent: '취소', style: 'background:#8e8e93; margin-left:8px;' });

      const btnArea = createElem('div', { className: 'btn-area' }, saveBtn, cancelBtn);
      taskDiv.appendChild(btnArea);

      saveBtn.onclick = () => {
        const inputs = taskDiv.querySelectorAll('input, select');
        let valid = true;
        const newData = {};
        fields.forEach(({ label }, i) => {
          const val = inputs[i].value.trim();
          if (label === '마감일' && val && isNaN(new Date(val))) {
            alert('유효한 날짜를 입력하세요.');
            valid = false;
            return;
          }
          newData[label] = val;
        });
        if (!valid) return;
        saveTask(student, category, taskId, newData).then(() => {
          loadTasks(student);
        });
      };

      cancelBtn.onclick = () => {
        loadTasks(student);
      };

    } else {
      // 일반 표시
      // 날짜 표시 (앞에), 나머지 항목은 한 줄 텍스트로 연결
      const dateVal = data['마감일'] || '';
      const dateSpan = createElem('span', { className: 'date-label', textContent: formatDateShort(dateVal) });
      taskDiv.appendChild(dateSpan);

      // 나머지 텍스트: 과목이나 내용 + 범위 (숨김 텍스트 없이 간결하게)
      let mainText = '';
      for (const key in data) {
        if (key !== '마감일') {
          if (mainText) mainText += ' | ';
          mainText += data[key];
        }
      }
      const textSpan = createElem('span', { textContent: mainText || '내용 없음' });
      taskDiv.appendChild(textSpan);

      // 버튼 영역 : 수정, 삭제, 완료(완료 카테고리에는 삭제만)
      const btnArea = createElem('div', { className: 'btn-area' });

      if (category !== 'completed' && category !== 'deleted') {
        const editBtn = createElem('button', { textContent: '수정' });
        const deleteBtn = createElem('button', { textContent: '삭제', style: 'background:#ff3b30;' });
        const completeBtn = createElem('button', { textContent: '완료', style: 'background:#34c759;' });

        editBtn.onclick = () => {
          loadTasks(student, category, taskId, true);
        };
        deleteBtn.onclick = () => {
          if (confirm('삭제하면 복구 불가능합니다. 삭제할까요?')) {
            deleteTask(student, category, taskId);
          }
        };
        completeBtn.onclick = () => {
          // 완료 카테고리로 이동
          remove(ref(db, `tasks/${student}/${category}/${taskId}`)).then(() => {
            saveTask(student, 'completed', taskId, data);
          });
        };

        btnArea.append(editBtn, completeBtn, deleteBtn);
      } else if (category === 'completed') {
        const undoBtn = createElem('button', { textContent: '복구', style: 'background:#ff9500;' });
        const deleteBtn = createElem('button', { textContent: '삭제', style: 'background:#ff3b30;' });

        undoBtn.onclick = () => {
          // 숙제, 공부, 시험, 수행평가 중 하나에 복구(여기서는 숙제로 일단 복구)
          remove(ref(db, `tasks/${student}/completed/${taskId}`)).then(() => {
            saveTask(student, '숙제', taskId, data);
          });
        };
        deleteBtn.onclick = () => {
          if (confirm('완전 삭제할까요?')) {
            deleteTask(student, 'completed', taskId);
          }
        };

        btnArea.append(undoBtn, deleteBtn);

      } else if (category === 'deleted') {
        // 비우기 버튼은 따로 있음. 그냥 비워진 공간 표시
        // 빈 task는 비활성화된 느낌
        taskDiv.style.opacity = '0.5';
        taskDiv.style.pointerEvents = 'none';
      }

      taskDiv.appendChild(btnArea);
    }

    return taskDiv;
  }

  // 전체 로드 및 렌더링 함수
  function loadTasks(student, editCategory = null, editTaskId = null, editing = false) {
    const studentRef = ref(db, `tasks/${student}`);
    onValue(studentRef, snapshot => {
      const data = snapshot.val() || {};

      // 각 카테고리 task-list 비우기
      ['숙제', '공부', '시험', '수행평가', 'completed', 'deleted'].forEach(cat => {
        const container = document.querySelector(`#${cat}-${student} .task-list`);
        if (!container) return;
        container.innerHTML = '';
        const catData = data[cat] || {};
        for (const [taskId, taskData] of Object.entries(catData)) {
          let isEditing = editing && editCategory === cat && editTaskId === taskId;
          const taskElem = createTaskElement(student, cat, taskId, taskData, isEditing);
          container.appendChild(taskElem);
        }
      });
    }, { onlyOnce: true });
  }

  // 새로운 task 추가
  function addTask(student, category) {
    const taskId = Date.now().toString();
    const defaultData = {};
    (categoryFields[category] || []).forEach(({ label, type }) => {
      defaultData[label] = '';
    });
    saveTask(student, category, taskId, defaultData).then(() => {
      loadTasks(student, category, taskId, true);
    });
  }

  // 삭제된 항목 비우기 (완전 삭제)
  function clearDeleted(student) {
    if (confirm('삭제된 항목을 완전히 비우시겠습니까?')) {
      remove(ref(db, `tasks/${student}/deleted`)).then(() => {
        loadTasks(student);
      });
    }
  }

  // 초기 세팅 및 이벤트 바인딩
  document.querySelectorAll('.add-btn').forEach(btn => {
    btn.addEventListener('click', e => {
      const student = btn.getAttribute('data-student');
      const category = btn.getAttribute('data-category');
      addTask(student, category);
    });
  });

  document.querySelector('.clear-deleted-btn').addEventListener('click', () => {
    clearDeleted('JH');
  });

  // 초기 로드
  loadTasks('JH');
</script>

</body>
</html>
